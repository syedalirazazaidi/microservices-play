version: '3.8'

services:
  # MongoDB instance shared by all services
  mongodb:
    image: mongo:7.0
    container_name: mongodb-shopping
    restart: unless-stopped
    ports:
      - '27017:27017'
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password123
    volumes:
      - mongodb-data:/data/db
    networks:
      - shopping-network

  user-service:
    image: node:18-alpine
    container_name: user-service
    working_dir: /app
    volumes:
      - ./services/user-service:/app
    command: sh -c "npm install && npm start"
    environment:
      PORT: 3001
      JWT_SECRET: super-secret-key
      JWT_EXPIRES_IN: 7d
      MONGODB_URI: mongodb://admin:password123@mongodb:27017/userdb?authSource=admin
    ports:
      - '3001:3001'
    depends_on:
      - mongodb
    networks:
      - shopping-network

  product-service:
    image: node:18-alpine
    container_name: product-service
    working_dir: /app
    volumes:
      - ./services/product-service:/app
    command: sh -c "npm install && npm start"
    environment:
      PORT: 3002
      MONGODB_URI: mongodb://admin:password123@mongodb:27017/productdb?authSource=admin
    ports:
      - '3002:3002'
    depends_on:
      - mongodb
    networks:
      - shopping-network

  cart-service:
    image: node:18-alpine
    container_name: cart-service
    working_dir: /app
    volumes:
      - ./services/cart-service:/app
    command: sh -c "npm install && npm start"
    environment:
      PORT: 3003
      MONGODB_URI: mongodb://admin:password123@mongodb:27017/cartdb?authSource=admin
      PRODUCT_SERVICE_URL: http://product-service:3002
    ports:
      - '3003:3003'
    depends_on:
      - mongodb
      - product-service
    networks:
      - shopping-network

  order-service:
    image: node:18-alpine
    container_name: order-service
    working_dir: /app
    volumes:
      - ./services/order-service:/app
    command: sh -c "npm install && npm start"
    environment:
      PORT: 3004
      MONGODB_URI: mongodb://admin:password123@mongodb:27017/orderdb?authSource=admin
      CART_SERVICE_URL: http://cart-service:3003
      USER_SERVICE_URL: http://user-service:3001
    ports:
      - '3004:3004'
    depends_on:
      - mongodb
      - cart-service
      - user-service
    networks:
      - shopping-network

  payment-service:
    image: node:18-alpine
    container_name: payment-service
    working_dir: /app
    volumes:
      - ./services/payment-service:/app
    command: sh -c "npm install && npm start"
    environment:
      PORT: 3005
      MONGODB_URI: mongodb://admin:password123@mongodb:27017/paymentdb?authSource=admin
      ORDER_SERVICE_URL: http://order-service:3004
    ports:
      - '3005:3005'
    depends_on:
      - mongodb
      - order-service
    networks:
      - shopping-network

  inventory-service:
    image: node:18-alpine
    container_name: inventory-service
    working_dir: /app
    volumes:
      - ./services/inventory-service:/app
    command: sh -c "npm install && npm start"
    environment:
      PORT: 3006
      MONGODB_URI: mongodb://admin:password123@mongodb:27017/inventorydb?authSource=admin
    ports:
      - '3006:3006'
    depends_on:
      - mongodb
    networks:
      - shopping-network

  api-gateway:
    image: node:18-alpine
    container_name: api-gateway
    working_dir: /app
    volumes:
      - ./api-gateway:/app
    command: sh -c "npm install && npm start"
    environment:
      PORT: 3000
      USER_SERVICE_URL: http://user-service:3001
      PRODUCT_SERVICE_URL: http://product-service:3002
      CART_SERVICE_URL: http://cart-service:3003
      ORDER_SERVICE_URL: http://order-service:3004
      PAYMENT_SERVICE_URL: http://payment-service:3005
      INVENTORY_SERVICE_URL: http://inventory-service:3006
    ports:
      - '3000:3000'
    depends_on:
      - user-service
      - product-service
      - cart-service
      - order-service
      - payment-service
      - inventory-service
    networks:
      - shopping-network

volumes:
  mongodb-data:

networks:
  shopping-network:
    driver: bridge

